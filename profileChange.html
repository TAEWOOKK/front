<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script  src="http://code.jquery.com/jquery-latest.min.js"></script>
</head>
<body>

  <!-- Add your site or application content here -->
  <p>프로필 체인지 페이지 입니다.</p>
  <!--<button type="button" onclick="location.href='signup.html'">회원가입 페이지 이동</button>-->
  <input type="text" name="access" id="access">
  <button type="button" onclick="token_Change()">access 토큰 입력</button>
  <input type="file" name="imageInput" id="imageInput">
  <button type="button" onclick="profile_Change()">프로필 변경</button>
</body>
<script>

  function token_Change(){
    var access = $('#access').val();
    localStorage.setItem('access',access);
  }

  function profile_Change(){

    // 로컬 스토리지에서 'access'라는 키로 저장된 값 가져오기
    var accessToken = localStorage.getItem('access');
    console.log(accessToken);

    const formData = new FormData();
    formData.append('profile', $('#imageInput').get(0).files[0]);

    $.ajax({
      type: "PATCH",
      url: "https://cinetalk.kro.kr/my/UserProfileChange",
      headers: {
        'access': accessToken
      },
      data: formData,
      processData: false,
      contentType: false,
      success: function(data) {
        alert(data);
      },
      error: function(request,xhr, status, error) {
        console.log("Status: " + status);
        console.log("Error: " + error);
      }
    });
  }

  function userinfo(){

    // 로컬 스토리지에서 'access'라는 키로 저장된 값 가져오기
    var accessToken = localStorage.getItem('access');
    console.log(accessToken);

    if(accessToken == null){
      reissue();
      return false;
    }

    $.ajax({
      type: "POST",
      url: "http://localhost:8081/userInfo",
      headers: {
        'access': accessToken
      },
      dataType : 'text',
      success: function(data) {
        alert(data);
      },
      error: function(request,xhr, status, error) {
        console.log("Status: " + status);
        console.log("Error: " + error);
        alert(request.responseText);
        reissue();
      }
    });
  }

  function reissue(){

    console.log('토큰 재생성 프론트 로직');

    $.ajax({
      type: "POST",
      url: "http://localhost:8081/reissue",
      contentType: "application/json; charset=utf-8",
      dataType: "text",
      xhrFields: {
        withCredentials: true // 클라이언트와 서버가 통신할때 쿠키 값을 공유하겠다는 설정
      },
      success: function(data, status, xhr) {
        // 받은 access 값을 헤더에서 추출하여 로컬 스토리지에 저장
        var access_token = xhr.getResponseHeader('access');
        if (access_token) {
          localStorage.setItem('access', access_token);
          alert("Access token 저장됨: " + access_token);
        } else {
          console.log("Access token이 헤더에 없습니다.");
        }
      },
      error: function(request,xhr, status, error) {
        console.log("Status: " + status);
        console.log("Error: " + error);
        alert(request.responseText);
      }
    });
  }

  function logout(){
    $.ajax({
      type: "POST",
      url: "http://localhost:8081/logout",
      contentType: "application/json; charset=utf-8",
      dataType: "text",
      xhrFields: {
        withCredentials: true   // 쿠키를 요청 헤더에 포함
      },
      success: function(data) {
        localStorage.removeItem('access');
        alert(data);
      },
      error: function(request,xhr, status, error) {
        console.log("Status: " + status);
        console.log("Error: " + error);
        alert(request.responseText);
      }
    });
  }


</script>
</html>
